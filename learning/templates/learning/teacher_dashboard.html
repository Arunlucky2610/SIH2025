{% extends 'learning/base.html' %}

{% block title %}Teacher Dashboard - Rural Digital Learning{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Enhanced Welcome Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="position-relative overflow-hidden rounded-4 p-5" style="background: linear-gradient(135deg, #198754 0%, #20c997 100%);">
                <!-- Background decoration -->
                <div class="position-absolute" style="top: -50px; right: -50px; width: 200px; height: 200px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                <div class="position-absolute" style="bottom: -30px; left: -30px; width: 150px; height: 150px; background: rgba(255,255,255,0.05); border-radius: 50%;"></div>
                
                <div class="row align-items-center position-relative">
                    <div class="col-lg-8">
                        <div class="text-white">
                            <h1 class="display-5 fw-bold mb-3 fade-in-up">
                                <i class="bi bi-mortarboard-fill me-3"></i>
                                Teacher Dashboard
                            </h1>
                            <p class="lead mb-4 opacity-90 fade-in-up" style="animation-delay: 0.1s;">
                                Empower rural education by monitoring student progress and managing quality learning content.
                            </p>
                            <div class="d-flex flex-wrap gap-3 fade-in-up" style="animation-delay: 0.2s;">
                                <div class="badge bg-white bg-opacity-20 text-white rounded-pill px-3 py-2">
                                    <i class="bi bi-calendar me-1"></i> 
                                    {{ today|date:"F d, Y" }}
                                </div>
                                <div class="badge bg-white bg-opacity-20 text-white rounded-pill px-3 py-2">
                                    <i class="bi bi-people me-1"></i> 
                                    {{ students|length }} Active Students
                                </div>
                                <div class="badge bg-white bg-opacity-20 text-white rounded-pill px-3 py-2">
                                    <i class="bi bi-book me-1"></i> 
                                    {{ lessons|length }} Lessons Created
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 text-end">
                        <div class="position-relative">
                            <i class="bi bi-person-workspace text-white opacity-25" style="font-size: 8rem;"></i>
                            <div class="position-absolute top-50 start-50 translate-middle">
                                <div class="bg-white rounded-circle p-3 shadow-lg">
                                    <i class="bi bi-person-check-fill text-success fs-2"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Overview Cards -->
    <div class="row mb-5">
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card dashboard-card text-center h-100 border-0 shadow-lg">
                <div class="card-body p-4">
                    <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                        <i class="bi bi-people-fill text-primary" style="font-size: 2.5rem;"></i>
                    </div>
                    <h5 class="card-title fw-bold text-primary">Active Students</h5>
                    <div class="display-4 fw-bold text-primary mb-2">{{ students|length }}</div>
                    <p class="card-text text-muted mb-3">Learning from you</p>
                    <div class="badge bg-primary bg-opacity-10 text-primary rounded-pill">
                        <i class="bi bi-graph-up me-1"></i>
                        Growing community
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card dashboard-card text-center h-100 border-0 shadow-lg">
                <div class="card-body p-4">
                    <div class="bg-success bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                        <i class="bi bi-book-fill text-success" style="font-size: 2.5rem;"></i>
                    </div>
                    <h5 class="card-title fw-bold text-success">Your Lessons</h5>
                    <div class="display-4 fw-bold text-success mb-2">{{ lessons|length }}</div>
                    <p class="card-text text-muted mb-3">Content created</p>
                    <a href="#lessons" class="btn btn-success btn-sm rounded-pill px-3">
                        <i class="bi bi-plus-circle me-1"></i>
                        Add New
                    </a>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card dashboard-card text-center h-100 border-0 shadow-lg">
                <div class="card-body p-4">
                    <div class="bg-info bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                        <i class="bi bi-check-circle-fill text-info" style="font-size: 2.5rem;"></i>
                    </div>
                    <h5 class="card-title fw-bold text-info">Avg Completion</h5>
                    <div class="display-4 fw-bold text-info mb-2">
                        {% if progress_summary %}
                            {{ progress_summary|first.progress_percentage|floatformat:0 }}%
                        {% else %}
                            0%
                        {% endif %}
                    </div>
                    <p class="card-text text-muted mb-3">Student success rate</p>
                    <div class="badge bg-info bg-opacity-10 text-info rounded-pill">
                        <i class="bi bi-trophy me-1"></i>
                        Excellent results
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card dashboard-card text-center h-100 border-0 shadow-lg">
                <div class="card-body p-4">
                    <div class="bg-warning bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                        <i class="bi bi-trophy-fill text-warning" style="font-size: 2.5rem;"></i>
                    </div>
                    <h5 class="card-title fw-bold text-warning">Avg Quiz Score</h5>
                    <div class="display-4 fw-bold text-warning mb-2">
                        {% if progress_summary %}
                            {{ progress_summary|first.avg_score|floatformat:0 }}%
                        {% else %}
                            0%
                        {% endif %}
                    </div>
                    <p class="card-text text-muted mb-3">Student performance</p>
                    <div class="badge bg-warning bg-opacity-10 text-warning rounded-pill">
                        <i class="bi bi-star me-1"></i>
                        Quality teaching
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Student Progress Table -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card dashboard-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-people"></i> Student Progress
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshData()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
                
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Student</th>
                                    <th>Language</th>
                                    <th>Progress</th>
                                    <th>Completed Lessons</th>
                                    <th>Average Score</th>
                                    <th>Last Activity</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for progress in progress_summary %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" 
                                                     style="width: 40px; height: 40px;">
                                                    {{ progress.student.first_name|first|default:progress.student.username|first }}
                                                </div>
                                                <div>
                                                    <div class="fw-bold">
                                                        {{ progress.student.first_name }} {{ progress.student.last_name }}
                                                    </div>
                                                    <small class="text-muted">{{ progress.student.username }}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">
                                                {{ progress.student.userprofile.get_language_preference_display }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar bg-info" role="progressbar" 
                                                     data-width="{{ progress.progress_percentage|floatformat:0 }}"
                                                     aria-valuenow="{{ progress.progress_percentage }}" 
                                                     aria-valuemin="0" aria-valuemax="100">
                                                    {{ progress.progress_percentage|floatformat:0 }}%
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="fw-bold">{{ progress.completed_lessons }}</span> / {{ progress.total_lessons }}
                                        </td>
                                        <td>
                                            {% if progress.avg_score > 0 %}
                                                <span class="badge {% if progress.avg_score >= 80 %}bg-success{% elif progress.avg_score >= 60 %}bg-warning{% else %}bg-danger{% endif %}">
                                                    {{ progress.avg_score }}%
                                                </span>
                                            {% else %}
                                                <span class="text-muted">No quizzes</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ progress.student.last_login|date:"M d, Y"|default:"Never" }}</small>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button class="btn btn-sm btn-outline-info" 
                                                        onclick="viewStudentDetails('{{ progress.student.id }}')">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-primary" 
                                                        onclick="sendMessage('{{ progress.student.id }}')">
                                                    <i class="bi bi-envelope"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="7" class="text-center py-4">
                                            <i class="bi bi-people text-muted" style="font-size: 3rem;"></i>
                                            <h6 class="text-muted mt-2">No students enrolled yet</h6>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Activity and Lessons -->
    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card dashboard-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history"></i> Recent Quiz Attempts
                    </h5>
                </div>
                <div class="card-body">
                    {% if recent_attempts %}
                        {% for attempt in recent_attempts %}
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <div class="fw-bold">{{ attempt.student.first_name }} {{ attempt.student.last_name }}</div>
                                    <small class="text-muted">{{ attempt.quiz.lesson.title }}</small>
                                </div>
                                <div class="text-end">
                                    <span class="badge {% if attempt.is_correct %}bg-success{% else %}bg-danger{% endif %}">
                                        {% if attempt.is_correct %}Correct{% else %}Incorrect{% endif %}
                                    </span>
                                    <br>
                                    <small class="text-muted">{{ attempt.attempted_at|date:"M d, H:i" }}</small>
                                </div>
                            </div>
                            {% if not forloop.last %}<hr class="my-2">{% endif %}
                        {% endfor %}
                    {% else %}
                        <p class="text-muted text-center mb-0">No recent quiz attempts</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-lg-6 mb-4">
            <div class="card dashboard-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-book"></i> Your Lessons
                    </h5>
                    {% if user.is_staff %}
                        <a href="/admin/learning/lesson/add/" class="btn btn-sm btn-primary">
                            <i class="bi bi-plus"></i> Add Lesson
                        </a>
                    {% endif %}
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for lesson in lessons|slice:":5" %}
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">{{ lesson.title }}</h6>
                                        <p class="mb-1 text-muted small">{{ lesson.description|truncatewords:10 }}</p>
                                        <small class="text-muted">
                                            {{ lesson.get_lesson_type_display }} • {{ lesson.get_language_display }}
                                        </small>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge {% if lesson.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                                            {% if lesson.is_active %}Active{% else %}Inactive{% endif %}
                                        </span>
                                        <br>
                                        <small class="text-muted">{{ lesson.created_at|date:"M d" }}</small>
                                    </div>
                                </div>
                            </div>
                        {% empty %}
                            <div class="text-center py-4">
                                <i class="bi bi-book text-muted" style="font-size: 3rem;"></i>
                                <h6 class="text-muted mt-2">No lessons created yet</h6>
                                {% if user.is_staff %}
                                    <a href="/admin/learning/lesson/add/" class="btn btn-primary">
                                        <i class="bi bi-plus"></i> Create Your First Lesson
                                    </a>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                    
                    {% if lessons|length > 5 %}
                        <div class="card-footer text-center">
                            <a href="/admin/learning/lesson/" class="btn btn-sm btn-outline-primary">
                                View All Lessons
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Student Details Modal -->
<div class="modal fade" id="studentDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Student Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="studentDetailsContent">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function refreshData() {
        location.reload();
    }
    
    function viewStudentDetails(studentId) {
        // This would normally fetch detailed student data
        // For now, just show a placeholder
        document.getElementById('studentDetailsContent').innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-custom"></div>
                <p class="mt-2">Loading student details...</p>
            </div>
        `;
        
        new bootstrap.Modal(document.getElementById('studentDetailsModal')).show();
        
        // Simulate loading
        setTimeout(() => {
            document.getElementById('studentDetailsContent').innerHTML = `
                <p>Detailed student progress view would be implemented here.</p>
                <p>This would include:</p>
                <ul>
                    <li>Individual lesson completion status</li>
                    <li>Quiz scores for each lesson</li>
                    <li>Time spent on each lesson</li>
                    <li>Learning patterns and recommendations</li>
                </ul>
            `;
        }, 1000);
    }
    
    function sendMessage(studentId) {
        alert('Messaging functionality would be implemented here.');
    }
    
    // Initialize progress bars and animations on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Animate progress bars
        document.querySelectorAll('.progress-bar[data-width]').forEach(bar => {
            const width = parseInt(bar.getAttribute('data-width')) || 0;
            bar.style.width = '0%';
            
            setTimeout(() => {
                bar.style.transition = 'width 1.5s ease-in-out';
                bar.style.width = width + '%';
            }, 200);
        });
        
        // Animate dashboard cards
        document.querySelectorAll('.dashboard-card').forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(30px)';
            
            setTimeout(() => {
                card.style.transition = 'all 0.6s ease';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, index * 100);
        });
        
        // Count up animation for numbers
        document.querySelectorAll('.display-4').forEach(element => {
            const target = parseInt(element.textContent);
            if (target && !isNaN(target)) {
                let current = 0;
                const increment = target / 50;
                const timer = setInterval(() => {
                    current += increment;
                    if (current >= target) {
                        current = target;
                        clearInterval(timer);
                    }
                    element.textContent = Math.floor(current);
                }, 40);
            }
        });
    });
</script>
{% endblock %}