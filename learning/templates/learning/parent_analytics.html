{% extends 'learning/base.html' %}
{% load static %}

{% block title %}Analytics - Parent Dashboard{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/ultra-modern.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .analytics-navigation {
            background: linear-gradient(135deg, rgba(139, 69, 19, 0.1), rgba(160, 82, 45, 0.05));
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: var(--shadow-soft);
        }

        .nav-tabs {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            border: none;
        }

        .nav-tab {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
            padding: 1rem 2rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s var(--ease-bounce);
            font-weight: 600;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-tab:hover, .nav-tab.active {
            background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
            color: white;
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .analytics-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 2rem;
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: var(--shadow-soft);
            transition: all 0.4s var(--ease-bounce);
        }

        .analytics-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-medium);
            background: rgba(255, 255, 255, 0.15);
        }

        .analytics-card h3 {
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .lesson-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .lesson-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }

        .lesson-info {
            flex: 1;
        }

        .lesson-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.3rem;
        }

        .lesson-subject {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .lesson-progress {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .progress-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 0.9rem;
        }

        .progress-complete {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
        }

        .progress-partial {
            background: linear-gradient(135deg, #FF9800, #FFC107);
        }

        .progress-pending {
            background: linear-gradient(135deg, #9E9E9E, #BDBDBD);
        }

        .time-spent {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }

        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-summary-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 1.5rem;
            border: 2px solid rgba(255, 255, 255, 0.2);
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-summary-card:hover {
            transform: translateY(-3px);
            background: rgba(255, 255, 255, 0.15);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 800;
            color: var(--accent-color);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-secondary);
            font-weight: 500;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="cosmic-hero" style="min-height: 200px; padding: 2rem 0;">
        <div class="container">
            <div class="hero-content text-center">
                <h1 class="hero-title cosmic-fade-in">üìä Learning Analytics</h1>
                <p class="hero-subtitle cosmic-fade-in">Comprehensive insights into your children's learning journey</p>
                
                <div class="analytics-navigation cosmic-fade-in">
                    <div class="nav-tabs">
                        <a href="#overview" class="nav-tab active" onclick="showTab('overview')">
                            üìà Overview
                        </a>
                        <a href="#subjects" class="nav-tab" onclick="showTab('subjects')">
                            üìö Subjects Analytics
                        </a>
                        <a href="#lessons" class="nav-tab" onclick="showTab('lessons')">
                            ÔøΩ Lessons Progress
                        </a>
                        <a href="#time" class="nav-tab" onclick="showTab('time')">
                            ‚è∞ Time Tracking
                        </a>
                        <a href="#performance" class="nav-tab" onclick="showTab('performance')">
                            üéØ Performance
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Overview Tab -->
        <div id="overview-tab" class="tab-content">
            <div class="stats-summary cosmic-fade-in">
                <div class="stat-summary-card">
                    <div class="stat-number">{{ total_lessons|default:0 }}</div>
                    <div class="stat-label">Total Lessons</div>
                </div>
                <div class="stat-summary-card">
                    <div class="stat-number">{{ completed_lessons|default:0 }}</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-summary-card">
                    <div class="stat-number">{{ completion_rate|default:0 }}%</div>
                    <div class="stat-label">Completion Rate</div>
                </div>
                <div class="stat-summary-card">
                    <div class="stat-number">{{ total_time_spent|default:"0h" }}</div>
                    <div class="stat-label">Time Spent</div>
                </div>
            </div>

            <div class="analytics-grid">
                <div class="analytics-card cosmic-fade-in">
                    <h3>üìä Progress Overview</h3>
                    <div class="chart-container">
                        <canvas id="progressChart"></canvas>
                    </div>
                </div>

                <div class="analytics-card cosmic-fade-in">
                    <h3>üìà Weekly Activity</h3>
                    <div class="chart-container">
                        <canvas id="activityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Subjects Analytics Tab -->
        <div id="subjects-tab" class="tab-content" style="display: none;">
            <div class="analytics-card cosmic-fade-in">
                <h3>üìö Subject-wise Performance Overview</h3>
                <div class="chart-container">
                    <canvas id="subjectsOverviewChart"></canvas>
                </div>
            </div>

            {% if subjects_data %}
                {% for subject, data in subjects_data.items %}
                <div class="analytics-card cosmic-fade-in" style="margin-bottom: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0;">
                            {% if subject == "Mathematics" %}üìä
                            {% elif subject == "Science" %}üî¨
                            {% elif subject == "English" %}üìù
                            {% elif subject == "Social Studies" %}üåç
                            {% elif subject == "Art" %}üé®
                            {% elif subject == "History" %}üìú
                            {% elif subject == "Geography" %}üó∫Ô∏è
                            {% elif subject == "Physics" %}‚öõÔ∏è
                            {% elif subject == "Chemistry" %}üß™
                            {% elif subject == "Biology" %}üå±
                            {% else %}üìñ
                            {% endif %}
                            {{ subject }}
                        </h3>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <div class="progress-circle {% if data.completion_rate >= 80 %}progress-complete{% elif data.completion_rate >= 50 %}progress-partial{% else %}progress-pending{% endif %}" style="width: 60px; height: 60px; font-size: 0.8rem;">
                                {{ data.completion_rate }}%
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <div class="stat-summary-card">
                            <div class="stat-number">{{ data.completed_lessons }}</div>
                            <div class="stat-label">Completed Lessons</div>
                        </div>
                        <div class="stat-summary-card">
                            <div class="stat-number">{{ data.total_lessons }}</div>
                            <div class="stat-label">Total Lessons</div>
                        </div>
                        <div class="stat-summary-card">
                            <div class="stat-number">{{ data.total_time_spent }}h</div>
                            <div class="stat-label">Time Spent</div>
                        </div>
                        <div class="stat-summary-card">
                            <div class="stat-number">{{ data.avg_performance }}%</div>
                            <div class="stat-label">Avg Performance</div>
                        </div>
                    </div>

                    <!-- Children Progress for this Subject -->
                    <h4 style="color: var(--text-primary); margin-bottom: 1rem; font-weight: 600;">üìà Individual Progress</h4>
                    {% for child_progress in data.children_progress %}
                    <div class="lesson-item">
                        <div class="lesson-info">
                            <div class="lesson-title">{{ child_progress.child_name }}</div>
                            <div class="lesson-subject">{{ child_progress.completed }}/{{ child_progress.total }} lessons completed ‚Ä¢ Score: {{ child_progress.avg_score }}%</div>
                        </div>
                        <div class="lesson-progress">
                            <div class="time-spent">{{ child_progress.time_spent }}h</div>
                            <div class="progress-circle {% if child_progress.completion_rate >= 80 %}progress-complete{% elif child_progress.completion_rate >= 50 %}progress-partial{% else %}progress-pending{% endif %}">
                                {{ child_progress.completion_rate }}%
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            {% else %}
                <div class="analytics-card cosmic-fade-in text-center">
                    <div style="padding: 3rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üìö</div>
                        <h3>No Subject Data Available</h3>
                        <p style="color: var(--text-secondary); margin-top: 1rem;">
                            Subject analytics will appear here once your children start completing lessons in different subjects.
                        </p>
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Lessons Tab -->
        <div id="lessons-tab" class="tab-content" style="display: none;">
            <div class="analytics-card cosmic-fade-in">
                <h3>üìö Detailed Lesson Progress</h3>
                
                <!-- Sample lesson data - replace with real data from Django -->
                <div class="lesson-item">
                    <div class="lesson-info">
                        <div class="lesson-title">Introduction to Mathematics</div>
                        <div class="lesson-subject">Mathematics ‚Ä¢ Grade 5</div>
                    </div>
                    <div class="lesson-progress">
                        <div class="time-spent">2h 30m</div>
                        <div class="progress-circle progress-complete">100%</div>
                    </div>
                </div>

                <div class="lesson-item">
                    <div class="lesson-info">
                        <div class="lesson-title">Basic Science Concepts</div>
                        <div class="lesson-subject">Science ‚Ä¢ Grade 5</div>
                    </div>
                    <div class="lesson-progress">
                        <div class="time-spent">1h 45m</div>
                        <div class="progress-circle progress-partial">75%</div>
                    </div>
                </div>

                <div class="lesson-item">
                    <div class="lesson-info">
                        <div class="lesson-title">English Grammar Basics</div>
                        <div class="lesson-subject">English ‚Ä¢ Grade 5</div>
                    </div>
                    <div class="lesson-progress">
                        <div class="time-spent">45m</div>
                        <div class="progress-circle progress-partial">50%</div>
                    </div>
                </div>

                <div class="lesson-item">
                    <div class="lesson-info">
                        <div class="lesson-title">History of India</div>
                        <div class="lesson-subject">Social Studies ‚Ä¢ Grade 5</div>
                    </div>
                    <div class="lesson-progress">
                        <div class="time-spent">0m</div>
                        <div class="progress-circle progress-pending">0%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Time Tab -->
        <div id="time-tab" class="tab-content" style="display: none;">
            <div class="analytics-grid">
                <div class="analytics-card cosmic-fade-in">
                    <h3>‚è∞ Daily Time Spent</h3>
                    <div class="chart-container">
                        <canvas id="timeChart"></canvas>
                    </div>
                </div>

                <div class="analytics-card cosmic-fade-in">
                    <h3>üìÖ Study Schedule</h3>
                    <div style="padding: 1rem;">
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">Weekly study pattern analysis</p>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span>Monday</span>
                            <span style="font-weight: 600;">2h 15m</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span>Tuesday</span>
                            <span style="font-weight: 600;">1h 45m</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span>Wednesday</span>
                            <span style="font-weight: 600;">3h 00m</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span>Thursday</span>
                            <span style="font-weight: 600;">2h 30m</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span>Friday</span>
                            <span style="font-weight: 600;">1h 30m</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Tab -->
        <div id="performance-tab" class="tab-content" style="display: none;">
            <div class="analytics-grid">
                <div class="analytics-card cosmic-fade-in">
                    <h3>üéØ Subject Performance</h3>
                    <div class="chart-container">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>

                <div class="analytics-card cosmic-fade-in">
                    <h3>üìä Learning Trends</h3>
                    <div class="chart-container">
                        <canvas id="trendsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Back to Dashboard Button -->
        <div class="text-center" style="margin: 3rem 0;">
            <a href="{% url 'parent_dashboard_ultra' %}" class="quantum-btn" style="padding: 1rem 2rem;">
                <span>‚Üê Back to Dashboard</span>
            </a>
        </div>
    </div>

    <script>
        // Tab switching functionality
        function showTab(tabName) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.style.display = 'none');
            
            // Remove active class from all nav tabs
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName + '-tab').style.display = 'block';
            
            // Add active class to clicked nav tab
            event.target.classList.add('active');
        }

        // Initialize charts when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
        });

        function initializeCharts() {
            // Subjects Overview Chart
            const subjectsCtx = document.getElementById('subjectsOverviewChart').getContext('2d');
            const subjectsData = [
                {% for subject, data in subjects_data.items %}
                {
                    subject: '{{ subject }}',
                    completion: {{ data.completion_rate|default:0 }},
                    lessons: {{ data.total_lessons|default:0 }},
                    time: {{ data.total_time_spent|default:0 }},
                    performance: {{ data.avg_performance|default:0 }}
                },
                {% endfor %}
            ];
            
            new Chart(subjectsCtx, {
                type: 'bar',
                data: {
                    labels: subjectsData.map(s => s.subject),
                    datasets: [{
                        label: 'Completion Rate (%)',
                        data: subjectsData.map(s => s.completion),
                        backgroundColor: ['#4CAF50', '#2196F3', '#FF9800', '#9C27B0', '#F44336', '#607D8B', '#795548'],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const index = context.dataIndex;
                                    const data = subjectsData[index];
                                    return [
                                        `Lessons: ${data.lessons}`,
                                        `Time: ${data.time}h`,
                                        `Performance: ${data.performance}%`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                color: '#ffffff',
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#ffffff'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });

            // Progress Overview Chart
            const progressCtx = document.getElementById('progressChart').getContext('2d');
            new Chart(progressCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'In Progress', 'Not Started'],
                    datasets: [{
                        data: [{{ completed_lessons|default:0 }}, {{ in_progress_lessons|default:2 }}, {{ pending_lessons|default:5 }}],
                        backgroundColor: ['#4CAF50', '#FF9800', '#9E9E9E'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#ffffff',
                                padding: 20
                            }
                        }
                    }
                }
            });

            // Weekly Activity Chart
            const activityCtx = document.getElementById('activityChart').getContext('2d');
            new Chart(activityCtx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Hours Studied',
                        data: [2.5, 1.8, 3.0, 2.3, 1.5, 2.8, 2.1],
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#ffffff'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#ffffff'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });

            // Time Chart
            const timeCtx = document.getElementById('timeChart').getContext('2d');
            new Chart(timeCtx, {
                type: 'bar',
                data: {
                    labels: ['Mathematics', 'Science', 'English', 'Social Studies', 'Art'],
                    datasets: [{
                        label: 'Time Spent (hours)',
                        data: [8.5, 6.2, 4.8, 3.5, 2.1],
                        backgroundColor: ['#4CAF50', '#2196F3', '#FF9800', '#9C27B0', '#F44336']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#ffffff'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#ffffff'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });

            // Performance Chart
            const performanceCtx = document.getElementById('performanceChart').getContext('2d');
            new Chart(performanceCtx, {
                type: 'radar',
                data: {
                    labels: ['Mathematics', 'Science', 'English', 'Social Studies', 'Art'],
                    datasets: [{
                        label: 'Performance Score',
                        data: [85, 78, 92, 67, 74],
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.2)',
                        pointBackgroundColor: '#4CAF50'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff'
                            }
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                color: '#ffffff'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            pointLabels: {
                                color: '#ffffff'
                            }
                        }
                    }
                }
            });

            // Trends Chart
            const trendsCtx = document.getElementById('trendsChart').getContext('2d');
            new Chart(trendsCtx, {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    datasets: [{
                        label: 'Overall Progress',
                        data: [20, 45, 68, 85],
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                color: '#ffffff'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#ffffff'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }
    </script>
{% endblock %}