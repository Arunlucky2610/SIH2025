{% extends 'learning/base.html' %}
{% load static %}

{% block title %}Teacher Communication - Rural Digital Learning{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/ultra-modern.css' %}">
<style>
.communication-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    border-radius: 20px;
    margin-bottom: 2rem;
    text-align: center;
    box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
}

.communication-card {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 20px;
    padding: 0;
    margin-bottom: 1.5rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: all 0.3s ease;
    overflow: hidden;
}

.communication-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15);
}

.card-header-solid {
    background: linear-gradient(135deg, #4a69bd 0%, #3c5aa6 100%);
    color: white !important;
    padding: 1.5rem 2rem;
    margin: 0;
    font-size: 1.3rem;
    font-weight: 600;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    border-bottom: 3px solid rgba(255, 255, 255, 0.2);
}

.card-content {
    padding: 2rem;
}

.child-card {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.5rem;
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    color: white !important;
    border-radius: 15px;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
}

.child-card h4, .child-card p {
    color: white !important;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
}

.child-card:hover {
    transform: scale(1.02);
    box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
}

.child-info h4 {
    margin: 0;
    font-size: 1.2rem;
    font-weight: 600;
}

.child-info p {
    margin: 0.5rem 0 0 0;
    opacity: 0.9;
}

.contact-teacher-btn {
    background: rgba(255, 255, 255, 0.2);
    border: 2px solid white;
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 25px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s ease;
}

.contact-teacher-btn:hover {
    background: white;
    color: #e74c3c;
    text-decoration: none;
    transform: scale(1.05);
}

.conversation-preview {
    border-left: 4px solid #4a69bd;
    padding: 1rem;
    margin-bottom: 1rem;
    background: rgba(74, 105, 189, 0.05);
    border-radius: 0 10px 10px 0;
    transition: all 0.3s ease;
}

.conversation-preview:hover {
    background: rgba(74, 105, 189, 0.1);
    transform: translateX(5px);
}

.conversation-title {
    font-weight: 600;
    color: white !important;
    margin-bottom: 0.5rem;
}

.conversation-title a {
    color: white !important;
    text-decoration: none;
    transition: color 0.3s ease;
    font-weight: 600;
}

.conversation-title a:hover {
    color: white !important;
}

.conversation-meta {
    font-size: 0.9rem;
    color: white !important;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 500;
}

.conversation-meta span {
    color: white !important;
}

/* Ensure text visibility in both light and dark themes */
.conversation-title,
.conversation-title a {
    color: white !important;
}

.conversation-meta,
.conversation-meta span {
    color: white !important;
}

/* Gradient theme adjustments */
body.gradient-theme .conversation-title,
body.gradient-theme .conversation-title a {
    color: white !important;
}

body.gradient-theme .conversation-meta,
body.gradient-theme .conversation-meta span {
    color: white !important;
}

/* Alert styling improvements */
.alert-info {
    background: linear-gradient(135deg, #3498db 0%, #2980b9 100%) !important;
    border: none !important;
    color: white !important;
    border-radius: 10px !important;
    padding: 1.5rem !important;
    text-align: center !important;
    font-weight: 500 !important;
    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3) !important;
}

.alert-info i {
    margin-right: 0.5rem;
    font-size: 1.1rem;
}

/* Enhanced text visibility */
.text-muted {
    color: white !important;
    font-weight: 500 !important;
}

body.white-theme .text-muted {
    color: white !important;
}

.unread-badge {
    background: #e74c3c;
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(231, 76, 60, 0.3);
}

.action-buttons {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
}

.action-btn {
    flex: 1;
    padding: 1rem;
    background: linear-gradient(135deg, #4a69bd 0%, #3c5aa6 100%);
    color: white !important;
    border: none;
    border-radius: 15px;
    font-weight: 600;
    text-decoration: none;
    text-align: center;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(74, 105, 189, 0.3);
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(74, 105, 189, 0.4);
    color: white !important;
    text-decoration: none;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
    color: white;
    padding: 1.5rem;
    border-radius: 15px;
    text-align: center;
    box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(39, 174, 96, 0.4);
}

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    color: white !important;
}

.stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
    color: white !important;
}

.help-section {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 20px;
    margin-bottom: 1.5rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    overflow: hidden;
}

.help-header {
    background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
    color: white;
    padding: 1.5rem 2rem;
    margin: 0;
    font-size: 1.3rem;
    font-weight: 600;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    border-bottom: 3px solid rgba(255, 255, 255, 0.2);
}

.help-content {
    padding: 2rem;
}

.help-content h6 {
    color: #000000;
    font-weight: 600;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #ecf0f1;
}

.help-content ul li {
    color: #000000;
    margin-bottom: 0.5rem;
    line-height: 1.5;
}

.help-content ul li::marker {
    color: #000000;
}

/* Gradient mode specific styling for help content */
body.gradient-theme .help-content h6 {
    color: #000000 !important;
}

body.gradient-theme .help-content ul li {
    color: #000000 !important;
}

body.gradient-theme .help-content ul li::marker {
    color: #000000 !important;
}

@media (max-width: 768px) {
    .action-buttons {
        flex-direction: column;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
}

/* Fix text blur in gradient theme - Remove ALL text shadows */
body.gradient-theme .communication-card *,
body.gradient-theme .help-section *,
body.gradient-theme .child-card *,
body.gradient-theme .card-header-solid *,
body.gradient-theme .help-header *,
.card-header-solid,
.child-card h4,
.child-card p,
.help-header,
.help-content * {
    text-shadow: none !important;
}

/* Ensure text selection works properly in gradient theme */
body.gradient-theme *::selection {
    background: #4F46E5 !important;
    color: white !important;
}

body.gradient-theme *::-moz-selection {
    background: #4F46E5 !important;
    color: white !important;
}

/* Global text shadow removal for this page */
* {
    text-shadow: none !important;
}

/* AI Smart Communication Hub Styling */
.smart-suggestions h5 {
    color: #2c3e50;
    margin-bottom: 1rem;
    font-weight: 600;
}

.suggestion-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.suggestion-card {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border: 2px solid #dee2e6;
    border-radius: 15px;
    padding: 1.5rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.suggestion-card:hover {
    background: linear-gradient(135deg, #e3f2fd, #bbdefb);
    border-color: #2196f3;
    transform: translateY(-3px);
    box-shadow: 0 4px 15px rgba(33,150,243,0.3);
}

.suggestion-card i {
    font-size: 2rem;
    color: #4a69bd;
    margin-bottom: 0.5rem;
    display: block;
}

.suggestion-card span {
    display: block;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 0.3rem;
}

.suggestion-card small {
    color: #6c757d;
    font-size: 0.8rem;
}

/* Voice Message Styling */
.voice-message-section h5 {
    color: #2c3e50;
    margin-bottom: 1rem;
    font-weight: 600;
}

.voice-controls {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
}

.voice-btn {
    padding: 0.8rem 1.5rem;
    border: none;
    border-radius: 25px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.voice-btn:not(.secondary):not(.success) {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: black !important;
}

.voice-btn.secondary {
    background: linear-gradient(135deg, #dc3545, #c82333);
    color: black !important;
}

.voice-btn.success {
    background: linear-gradient(135deg, #28a745, #1e7e34);
    color: black !important;
}

.voice-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.voice-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.voice-feedback {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 10px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.voice-feedback.recording {
    background: #fff3cd;
    border-color: #ffeaa7;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}

.transcription-box {
    background: #e8f5e8;
    border: 1px solid #c3e6c3;
    border-radius: 10px;
    padding: 1rem;
    margin-top: 1rem;
}

.transcription-box h6 {
    color: #155724;
    margin-bottom: 0.5rem;
}

.transcribed-text {
    background: white;
    padding: 0.8rem;
    border-radius: 8px;
    margin-bottom: 0.5rem;
    border: 1px solid #c3e6c3;
}

.translation {
    background: #cce5ff;
    padding: 0.8rem;
    border-radius: 8px;
    border: 1px solid #99d6ff;
}

/* Language Selection Styling */
.language-selection h5 {
    color: #2c3e50;
    margin-bottom: 1rem;
    font-weight: 600;
}

.language-options {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.lang-btn {
    padding: 0.5rem 1rem;
    border: 2px solid #dee2e6;
    background: white;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
}

.lang-btn.active,
.lang-btn:hover {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    border-color: #28a745;
}

/* Quick Composer Styling */
.quick-composer h5 {
    color: #2c3e50;
    margin-bottom: 1rem;
    font-weight: 600;
}

.message-form textarea {
    border: 2px solid #dee2e6;
    border-radius: 10px;
    resize: vertical;
    font-size: 1rem;
}

.message-form textarea:focus {
    border-color: #4a69bd;
    box-shadow: 0 0 0 0.2rem rgba(74, 105, 189, 0.25);
}

.composer-actions {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.composer-actions .action-btn {
    flex: 1;
    min-width: 150px;
}

/* Responsive Design */
@media (max-width: 768px) {
    .suggestion-cards {
        grid-template-columns: 1fr;
    }
    
    .voice-controls {
        flex-direction: column;
    }
    
    .voice-btn {
        justify-content: center;
    }
    
    .language-options {
        justify-content: center;
    }
    
    .composer-actions {
        flex-direction: column;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Back to Dashboard Button (Top) -->
    <div class="mb-3">
        <a href="{% url 'parent_dashboard' %}" class="btn btn-success" style="background: linear-gradient(135deg, #28a745, #20c997); border: none; border-radius: 10px; padding: 0.75rem 1.5rem; font-weight: 600; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3); color: white;">
            <i class="fas fa-arrow-left me-2"></i> Back to Dashboard
        </a>
    </div>
    
    <div class="communication-header">
        <h1 style="color: white !important;">üë©‚Äçüè´ Teacher Communication</h1>
        {% if request.user.userprofile.child_name %}
            <p style="color: white !important;">Connect with {{ request.user.userprofile.child_name }}'s teachers and stay involved in their learning journey</p>
        {% else %}
            <p style="color: white !important;">Connect with your child's teachers and stay involved in their learning journey</p>
        {% endif %}
    </div>

    <!-- Statistics -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number" style="color: white !important;">{{ recent_conversations.count }}</div>
            <div class="stat-label" style="color: white !important;">Active Conversations</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" style="color: white !important;">{{ unread_count }}</div>
            <div class="stat-label" style="color: white !important;">Unread Messages</div>
        </div>
    </div>

    <!-- AI-Powered Smart Communication Features -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="communication-card force-white-text">
                <h3 class="card-header-solid" style="color: white !important;">ü§ñ AI Smart Communication Hub</h3>
                <div class="card-content">
                    <!-- Quick Smart Suggestions -->
                    <div class="smart-suggestions mb-4">
                        <h5 style="color: white !important;"><i class="bi bi-lightbulb-fill text-warning"></i> Smart Suggestions Based on Your Child's Progress</h5>
                        <div class="suggestion-cards">
                            <div class="suggestion-card" onclick="fillQuickMessage('ask-math-help')">
                                <i class="bi bi-calculator"></i>
                                <span>Ask about Math Help</span>
                                <small>Ravi's math scores need attention</small>
                            </div>
                            <div class="suggestion-card" onclick="fillQuickMessage('schedule-meeting')">
                                <i class="bi bi-calendar-check"></i>
                                <span>Schedule Parent Meeting</span>
                                <small>Recommended for progress discussion</small>
                            </div>
                            <div class="suggestion-card" onclick="fillQuickMessage('homework-support')">
                                <i class="bi bi-book"></i>
                                <span>Request Homework Support</span>
                                <small>Extra guidance needed</small>
                            </div>
                        </div>
                    </div>

                    <!-- Voice Message Feature -->
                    <div class="voice-message-section mb-4">
                        <h5 style="color: white !important;"><i class="bi bi-mic-fill text-primary"></i> Voice Message (Speak in Your Language)</h5>
                        <div class="voice-controls">
                            <button class="voice-btn" id="startRecording">
                                <i class="bi bi-mic"></i>
                                Start Recording
                            </button>
                            <button class="voice-btn secondary" id="stopRecording" disabled>
                                <i class="bi bi-stop-circle"></i>
                                Stop Recording
                            </button>
                            <button class="voice-btn success" id="playRecording" disabled>
                                <i class="bi bi-play-circle"></i>
                                Play Back
                            </button>
                        </div>
                        <div class="voice-feedback" id="voiceFeedback">
                            <p style="color: white !important;"><i class="bi bi-info-circle"></i> Click "Start Recording" to record your message in Hindi, Bengali, or any local language</p>
                        </div>
                        <div class="transcription-box" id="transcriptionBox" style="display: none;">
                            <h6 style="color: white !important;">Auto-Transcribed Text:</h6>
                            <div class="transcribed-text" id="transcribedText"></div>
                            <div class="translation" id="translationText"></div>
                        </div>
                    </div>

                    <!-- Language Selection -->
                    <div class="language-selection mb-4">
                        <h5 style="color: white !important;"><i class="bi bi-translate text-success"></i> Language Support</h5>
                        <div class="language-options">
                            <button class="lang-btn" data-lang="en">English</button>
                            <button class="lang-btn" data-lang="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä</button>
                            <button class="lang-btn" data-lang="pa">‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä</button>
                        </div>
                    </div>

                    <!-- Quick Message Composer -->
                    <div class="quick-composer">
                        <h5 style="color: white !important;"><i class="bi bi-chat-dots text-info"></i> Quick Message Composer</h5>
                        <div class="message-form">
                            <textarea id="quickMessage" class="form-control mb-3" rows="4" placeholder="Type your message here or use voice recording above..."></textarea>
                            <div class="composer-actions">
                                <button class="action-btn" onclick="translateMessage()" style="color: white !important;">
                                    <i class="bi bi-translate"></i>
                                    Auto-Translate
                                </button>
                                <button class="action-btn" onclick="sendQuickMessage()" style="color: white !important;">
                                    <i class="bi bi-send"></i>
                                    Send Message
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons" style="display: flex !important; flex-wrap: wrap; gap: 1rem; margin-top: 2rem; visibility: visible;">
        <a href="{% url 'conversation_list' %}" class="action-btn" style="color: white !important;">
            <i class="fas fa-list"></i> View All Conversations
        </a>
        <a href="#" onclick="showComingSoon()" class="action-btn" style="color: white !important;">
            <i class="fas fa-calendar"></i> Schedule Meeting
        </a>
        <a href="#" onclick="showComingSoon()" class="action-btn" style="color: white !important;">
            <i class="fas fa-bell"></i> Notification Settings
        </a>
    </div>

    <!-- Quick Help -->
    <div class="help-section mt-4">
        <h4 class="help-header">üìã How to Use Teacher Communication</h4>
        <div class="help-content">
            <div class="row">
                <div class="col-md-6">
                    <h6>üéØ What you can do:</h6>
                    <ul>
                        <li>Send messages to class teachers and subject teachers</li>
                        <li>Discuss your child's progress and performance</li>
                        <li>Ask questions about homework and assignments</li>
                        <li>Request parent-teacher meetings</li>
                        <li>Get updates on classroom activities</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6>üí° Tips for effective communication:</h6>
                    <ul>
                        <li>Be specific about your concerns or questions</li>
                        <li>Include your child's name in the subject line</li>
                        <li>Be respectful and professional in your messages</li>
                        <li>Allow 24-48 hours for teacher responses</li>
                        <li>Use appropriate priority levels for urgent matters</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// AI Smart Communication Hub JavaScript

let mediaRecorder;
let audioChunks = [];
let currentLanguage = 'en';
let recordedAudio = null;

// Smart suggestion messages
const smartMessages = {
    'ask-math-help': "Hello teacher, I've noticed that my child is struggling with mathematics. Could you please provide some additional guidance or suggest extra practice materials? I would appreciate any recommendations for helping them improve their math skills at home.",
    'schedule-meeting': "Dear teacher, I would like to schedule a parent-teacher meeting to discuss my child's progress. Please let me know your available times this week or next week. I'm flexible with timing and can adjust according to your schedule.",
    'homework-support': "Hello, my child seems to need some extra support with their homework assignments. Could you please provide some additional explanations or resources? I want to ensure they understand the concepts properly and complete their work effectively."
};

// Fill quick message based on suggestion
function fillQuickMessage(type) {
    const messageBox = document.getElementById('quickMessage');
    const originalMessage = smartMessages[type];
    
    // Translate the message if not in English
    const translatedMessage = translateFullMessage(originalMessage, currentLanguage);
    messageBox.value = translatedMessage;
    messageBox.focus();
    
    // Add visual feedback
    messageBox.style.borderColor = '#28a745';
    setTimeout(() => {
        messageBox.style.borderColor = '';
    }, 2000);
    
    // Show translation feedback if language is not English
    if (currentLanguage !== 'en' && translatedMessage !== originalMessage) {
        const feedback = document.getElementById('voiceFeedback');
        feedback.innerHTML = `
            <p class="text-success"><i class="bi bi-translate"></i> Smart suggestion translated to ${document.querySelector('.lang-btn.active').textContent}!</p>
        `;
        setTimeout(() => {
            feedback.innerHTML = `
                <p><i class="bi bi-info-circle"></i> Language set to: ${document.querySelector('.lang-btn.active').textContent}. Click "Start Recording" to record your message.</p>
            `;
        }, 3000);
    }
}

// Voice Recording Functions
document.getElementById('startRecording').addEventListener('click', startRecording);
document.getElementById('stopRecording').addEventListener('click', stopRecording);
document.getElementById('playRecording').addEventListener('click', playRecording);

async function startRecording() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        mediaRecorder.addEventListener("dataavailable", event => {
            audioChunks.push(event.data);
        });
        
        mediaRecorder.addEventListener("stop", () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            recordedAudio = audioBlob;
            
            // Simulate transcription (in real app, this would call speech-to-text API)
            simulateTranscription();
        });
        
        mediaRecorder.start();
        
        // Update UI
        document.getElementById('startRecording').disabled = true;
        document.getElementById('stopRecording').disabled = false;
        document.getElementById('voiceFeedback').innerHTML = `
            <p class="text-primary"><i class="bi bi-mic-fill"></i> Recording... Speak clearly in your preferred language</p>
        `;
        document.getElementById('voiceFeedback').classList.add('recording');
        
    } catch (error) {
        alert('Microphone access denied. Please allow microphone access and try again.');
        console.error('Error accessing microphone:', error);
    }
}

function stopRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
        
        // Update UI
        document.getElementById('startRecording').disabled = false;
        document.getElementById('stopRecording').disabled = true;
        document.getElementById('playRecording').disabled = false;
        document.getElementById('voiceFeedback').innerHTML = `
            <p class="text-success"><i class="bi bi-check-circle"></i> Recording completed! Processing transcription...</p>
        `;
        document.getElementById('voiceFeedback').classList.remove('recording');
    }
}

function playRecording() {
    if (recordedAudio) {
        const audioUrl = URL.createObjectURL(recordedAudio);
        const audio = new Audio(audioUrl);
        audio.play();
        
        // Visual feedback
        const playBtn = document.getElementById('playRecording');
        const originalText = playBtn.innerHTML;
        playBtn.innerHTML = '<i class="bi bi-volume-up"></i> Playing...';
        
        audio.addEventListener('ended', () => {
            playBtn.innerHTML = originalText;
        });
    }
}

// Simulate transcription and translation
function simulateTranscription() {
    setTimeout(() => {
        const transcriptionBox = document.getElementById('transcriptionBox');
        const transcribedText = document.getElementById('transcribedText');
        const translationText = document.getElementById('translationText');
        const messageBox = document.getElementById('quickMessage');
        
        // Simulate transcribed text based on selected language
        let sampleText = "";
        let englishTranslation = "";
        
        switch(currentLanguage) {
            case 'hi':
                sampleText = "‡§®‡§Æ‡§∏‡•ç‡§§‡•á ‡§∂‡§ø‡§ï‡•ç‡§∑‡§ï ‡§ú‡•Ä, ‡§Æ‡•á‡§∞‡•á ‡§¨‡§ö‡•ç‡§ö‡•á ‡§ï‡•ã ‡§ó‡§£‡§ø‡§§ ‡§Æ‡•á‡§Ç ‡§ï‡•Å‡§õ ‡§ï‡§†‡§ø‡§®‡§æ‡§à ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡•Å‡§õ ‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç‡•§";
                englishTranslation = "Hello teacher, my child is having some difficulty in mathematics. Please provide some additional help.";
                break;
            case 'pa':
                sampleText = "‡®∏‡®§ ‡®∏‡©ç‡®∞‡©Ä ‡®Ö‡®ï‡®æ‡®≤ ‡®Ö‡®ß‡®ø‡®Ü‡®™‡®ï ‡®ú‡©Ä, ‡®Æ‡©á‡®∞‡©á ‡®¨‡©±‡®ö‡©á ‡®®‡©Ç‡©∞ ‡®ó‡®£‡®ø‡®§ ‡®µ‡®ø‡©±‡®ö ‡®Æ‡©Å‡®∏‡®º‡®ï‡®ø‡®≤ ‡®π‡©ã ‡®∞‡®π‡©Ä ‡®π‡©à‡•§ ‡®ï‡®ø‡®∞‡®™‡®æ ‡®ï‡®∞‡®ï‡©á ‡®ï‡©Å‡®ù ‡®µ‡®æ‡®ß‡©Ç ‡®Æ‡®¶‡®¶ ‡®ï‡®∞‡©ã‡•§";
                englishTranslation = "Hello teacher, my child is having some difficulty in mathematics. Please provide some additional help.";
                break;
            default:
                sampleText = "Hello teacher, my child is having some difficulty with their studies. Could you please provide some guidance?";
                englishTranslation = sampleText;
        }
        
        transcribedText.textContent = sampleText;
        translationText.innerHTML = `<strong>English Translation:</strong> ${englishTranslation}`;
        messageBox.value = englishTranslation;
        
        transcriptionBox.style.display = 'block';
        
        // Update feedback
        document.getElementById('voiceFeedback').innerHTML = `
            <p class="text-success"><i class="bi bi-check-circle"></i> Voice message transcribed and translated successfully!</p>
        `;
    }, 2000);
}

// Language Selection
document.querySelectorAll('.lang-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        // Remove active class from all buttons
        document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
        // Add active class to clicked button
        this.classList.add('active');
        // Update current language
        currentLanguage = this.dataset.lang;
        
        // Update UI feedback
        const languages = {
            'en': 'English',
            'hi': 'Hindi (‡§π‡§ø‡§Ç‡§¶‡•Ä)',
            'pa': 'Punjabi (‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä)'
        };
        
        document.getElementById('voiceFeedback').innerHTML = `
            <p><i class="bi bi-info-circle"></i> Language set to: ${languages[currentLanguage]}. Click "Start Recording" to record your message.</p>
        `;
    });
});

// Translate Message Function
function translateMessage() {
    const messageBox = document.getElementById('quickMessage');
    const message = messageBox.value.trim();
    
    if (!message) {
        alert('Please enter a message to translate.');
        return;
    }
    
    // Translate using local dictionary
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> Translating...';
    button.disabled = true;
    
    setTimeout(() => {
        const translatedMessage = translateFullMessage(message, currentLanguage);
        
        if (translatedMessage !== message) {
            messageBox.value = translatedMessage;
            alert(`Message translated to ${document.querySelector('.lang-btn.active').textContent}!`);
        } else {
            if (currentLanguage === 'en') {
                alert('Message is already in English!');
            } else {
                alert('Translation completed. Some phrases may remain in English if no translation is available.');
                messageBox.value = translatedMessage;
            }
        }
        
        button.innerHTML = originalText;
        button.disabled = false;
    }, 1500);
}

// Comprehensive translation function
function translateFullMessage(message, targetLang) {
    if (targetLang === 'en') {
        return message; // Already in English
    }
    
    // Educational phrases translation dictionary
    const translations = {
        'hi': {
            // Greetings and formal phrases
            'Hello teacher': '‡§®‡§Æ‡§∏‡•ç‡§§‡•á ‡§∂‡§ø‡§ï‡•ç‡§∑‡§ï ‡§ú‡•Ä',
            'Dear teacher': '‡§™‡•ç‡§∞‡§ø‡§Ø ‡§∂‡§ø‡§ï‡•ç‡§∑‡§ï ‡§ú‡•Ä',
            'Good morning': '‡§∏‡•Å‡§™‡•ç‡§∞‡§≠‡§æ‡§§',
            'Good evening': '‡§∂‡•Å‡§≠ ‡§∏‡§Ç‡§ß‡•ç‡§Ø‡§æ',
            'Thank you': '‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶',
            'Please': '‡§ï‡•É‡§™‡§Ø‡§æ',
            
            // Academic subjects
            'mathematics': '‡§ó‡§£‡§ø‡§§',
            'math': '‡§ó‡§£‡§ø‡§§',
            'science': '‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§®',
            'english': '‡§Ö‡§Ç‡§ó‡•ç‡§∞‡•á‡§ú‡•Ä',
            'hindi': '‡§π‡§ø‡§Ç‡§¶‡•Ä',
            'social studies': '‡§∏‡§æ‡§Æ‡§æ‡§ú‡§ø‡§ï ‡§Ö‡§ß‡•ç‡§Ø‡§Ø‡§®',
            'computer': '‡§ï‡§Ç‡§™‡•ç‡§Ø‡•Ç‡§ü‡§∞',
            
            // Common parent concerns
            'my child': '‡§Æ‡•á‡§∞‡§æ ‡§¨‡§ö‡•ç‡§ö‡§æ',
            'homework': '‡§ó‡•É‡§π‡§ï‡§æ‡§∞‡•ç‡§Ø',
            'assignment': '‡§ï‡§æ‡§∞‡•ç‡§Ø',
            'test': '‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ',
            'exam': '‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ',
            'difficulty': '‡§ï‡§†‡§ø‡§®‡§æ‡§à',
            'problem': '‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ',
            'help': '‡§∏‡§π‡§æ‡§Ø‡§§‡§æ',
            'support': '‡§∏‡§Æ‡§∞‡•ç‡§•‡§®',
            'guidance': '‡§Æ‡§æ‡§∞‡•ç‡§ó‡§¶‡§∞‡•ç‡§∂‡§®',
            'progress': '‡§™‡•ç‡§∞‡§ó‡§§‡§ø',
            'improvement': '‡§∏‡•Å‡§ß‡§æ‡§∞',
            
            // Action phrases
            'having difficulty': '‡§ï‡§†‡§ø‡§®‡§æ‡§à ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à',
            'need help': '‡§∏‡§π‡§æ‡§Ø‡§§‡§æ ‡§ö‡§æ‡§π‡§ø‡§è',
            'please provide': '‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç',
            'could you': '‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™',
            'would like to': '‡§ö‡§æ‡§π‡§§‡§æ ‡§π‡•Ç‡§Ç',
            'schedule a meeting': '‡§¨‡•à‡§†‡§ï ‡§ï‡§æ ‡§∏‡§Æ‡§Ø ‡§®‡§ø‡§∞‡•ç‡§ß‡§æ‡§∞‡§ø‡§§ ‡§ï‡§∞‡§®‡§æ',
            'discuss': '‡§ö‡§∞‡•ç‡§ö‡§æ ‡§ï‡§∞‡§®‡§æ',
            'understand': '‡§∏‡§Æ‡§ù‡§®‡§æ',
            
            // Common sentences
            'I would like to schedule a parent-teacher meeting': '‡§Æ‡•à‡§Ç ‡§Ö‡§≠‡§ø‡§≠‡§æ‡§µ‡§ï-‡§∂‡§ø‡§ï‡•ç‡§∑‡§ï ‡§¨‡•à‡§†‡§ï ‡§ï‡§æ ‡§∏‡§Æ‡§Ø ‡§®‡§ø‡§∞‡•ç‡§ß‡§æ‡§∞‡§ø‡§§ ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡§æ ‡§π‡•Ç‡§Ç',
            'Please provide additional guidance': '‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ ‡§Æ‡§æ‡§∞‡•ç‡§ó‡§¶‡§∞‡•ç‡§∂‡§® ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç',
            'My child needs extra support': '‡§Æ‡•á‡§∞‡•á ‡§¨‡§ö‡•ç‡§ö‡•á ‡§ï‡•ã ‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•à',
            'Thank you for your time': '‡§Ü‡§™‡§ï‡•á ‡§∏‡§Æ‡§Ø ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶'
        },
        'pa': {
            // Greetings and formal phrases
            'Hello teacher': '‡®∏‡®§ ‡®∏‡©ç‡®∞‡©Ä ‡®Ö‡®ï‡®æ‡®≤ ‡®Ö‡®ß‡®ø‡®Ü‡®™‡®ï ‡®ú‡©Ä',
            'Dear teacher': '‡®™‡®ø‡®Ü‡®∞‡©á ‡®Ö‡®ß‡®ø‡®Ü‡®™‡®ï ‡®ú‡©Ä',
            'Good morning': '‡®∏‡©Å‡®™‡©ç‡®∞‡®≠‡®æ‡®§',
            'Good evening': '‡®∏‡®º‡©Å‡®≠ ‡®∏‡®º‡®æ‡®Æ',
            'Thank you': '‡®ß‡©∞‡®®‡®µ‡®æ‡®¶',
            'Please': '‡®ï‡®ø‡®∞‡®™‡®æ ‡®ï‡®∞‡®ï‡©á',
            
            // Academic subjects
            'mathematics': '‡®ó‡®£‡®ø‡®§',
            'math': '‡®ó‡®£‡®ø‡®§',
            'science': '‡®µ‡®ø‡®ó‡®ø‡®Ü‡®®',
            'english': '‡®Ö‡©∞‡®ó‡®∞‡©á‡®ú‡®º‡©Ä',
            'punjabi': '‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä',
            'social studies': '‡®∏‡®Æ‡®æ‡®ú‡®ø‡®ï ‡®Ö‡®ß‡®ø‡®ê‡®®',
            'computer': '‡®ï‡©∞‡®™‡®ø‡®ä‡®ü‡®∞',
            
            // Common parent concerns
            'my child': '‡®Æ‡©á‡®∞‡®æ ‡®¨‡©±‡®ö‡®æ',
            'homework': '‡®ò‡®∞ ‡®¶‡®æ ‡®ï‡©∞‡®Æ',
            'assignment': '‡®ï‡®æ‡®∞‡®ú',
            'test': '‡®ü‡©à‡®∏‡®ü',
            'exam': '‡®á‡®Æ‡®§‡®ø‡®π‡®æ‡®®',
            'difficulty': '‡®Æ‡©Å‡®∏‡®º‡®ï‡®ø‡®≤',
            'problem': '‡®∏‡®Æ‡©±‡®∏‡®ø‡®Ü',
            'help': '‡®Æ‡®¶‡®¶',
            'support': '‡®∏‡®π‡®æ‡®á‡®§‡®æ',
            'guidance': '‡®Æ‡®æ‡®∞‡®ó‡®¶‡®∞‡®∏‡®º‡®®',
            'progress': '‡®§‡®∞‡©±‡®ï‡©Ä',
            'improvement': '‡®∏‡©Å‡®ß‡®æ‡®∞',
            
            // Action phrases
            'having difficulty': '‡®Æ‡©Å‡®∏‡®º‡®ï‡®ø‡®≤ ‡®π‡©ã ‡®∞‡®π‡©Ä ‡®π‡©à',
            'need help': '‡®Æ‡®¶‡®¶ ‡®ö‡®æ‡®π‡©Ä‡®¶‡©Ä ‡®π‡©à',
            'please provide': '‡®ï‡®ø‡®∞‡®™‡®æ ‡®ï‡®∞‡®ï‡©á ‡®¶‡®ø‡®ì',
            'could you': '‡®ï‡©Ä ‡®§‡©Å‡®∏‡©Ä‡®Ç',
            'would like to': '‡®ö‡®æ‡®π‡©Å‡©∞‡®¶‡®æ ‡®π‡®æ‡®Ç',
            'schedule a meeting': '‡®Æ‡©Ä‡®ü‡®ø‡©∞‡®ó ‡®¶‡®æ ‡®∏‡®Æ‡®æ‡®Ç ‡®§‡©à‡®Ö ‡®ï‡®∞‡®®‡®æ',
            'discuss': '‡®ö‡®∞‡®ö‡®æ ‡®ï‡®∞‡®®‡®æ',
            'understand': '‡®∏‡®Æ‡®ù‡®£‡®æ',
            
            // Common sentences
            'I would like to schedule a parent-teacher meeting': '‡®Æ‡©à‡®Ç ‡®Æ‡®æ‡®§‡®æ-‡®™‡®ø‡®§‡®æ-‡®Ö‡®ß‡®ø‡®Ü‡®™‡®ï ‡®Æ‡©Ä‡®ü‡®ø‡©∞‡®ó ‡®¶‡®æ ‡®∏‡®Æ‡®æ‡®Ç ‡®®‡®ø‡®∞‡®ß‡®æ‡®∞‡®§ ‡®ï‡®∞‡®®‡®æ ‡®ö‡®æ‡®π‡©Å‡©∞‡®¶‡®æ ‡®π‡®æ‡®Ç',
            'Please provide additional guidance': '‡®ï‡®ø‡®∞‡®™‡®æ ‡®ï‡®∞‡®ï‡©á ‡®µ‡®æ‡®ß‡©Ç ‡®Æ‡®æ‡®∞‡®ó‡®¶‡®∞‡®∏‡®º‡®® ‡®™‡©ç‡®∞‡®¶‡®æ‡®® ‡®ï‡®∞‡©ã',
            'My child needs extra support': '‡®Æ‡©á‡®∞‡©á ‡®¨‡©±‡®ö‡©á ‡®®‡©Ç‡©∞ ‡®µ‡®æ‡®ß‡©Ç ‡®∏‡®π‡®æ‡®á‡®§‡®æ ‡®¶‡©Ä ‡®≤‡©ã‡©ú ‡®π‡©à',
            'Thank you for your time': '‡®§‡©Å‡®π‡®æ‡®°‡©á ‡®∏‡®Æ‡©á‡®Ç ‡®≤‡®à ‡®ß‡©∞‡®®‡®µ‡®æ‡®¶'
        }
    };
    
    let translatedMessage = message;
    const langDict = translations[targetLang];
    
    if (langDict) {
        // Sort by length (longest first) to handle phrases before individual words
        const sortedKeys = Object.keys(langDict).sort((a, b) => b.length - a.length);
        
        for (const englishPhrase of sortedKeys) {
            const regex = new RegExp('\\b' + englishPhrase.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'gi');
            translatedMessage = translatedMessage.replace(regex, langDict[englishPhrase]);
        }
    }
    
    return translatedMessage;
}

// Send Quick Message Function
function sendQuickMessage() {
    const messageBox = document.getElementById('quickMessage');
    const message = messageBox.value.trim();
    
    if (!message) {
        alert('Please enter a message to send.');
        return;
    }
    
    // Simulate sending (in real app, this would send to backend)
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> Sending...';
    button.disabled = true;
    
    setTimeout(() => {
        alert('Message sent successfully! The teacher will receive your message and respond soon.');
        messageBox.value = '';
        
        // Reset voice recording if any
        document.getElementById('transcriptionBox').style.display = 'none';
        document.getElementById('voiceFeedback').innerHTML = `
            <p><i class="bi bi-info-circle"></i> Message sent! You can record another voice message if needed.</p>
        `;
        
        button.innerHTML = originalText;
        button.disabled = false;
    }, 2000);
}

// Auto-refresh unread count every 30 seconds
setInterval(function() {
    // You can implement AJAX call to update unread count
}, 30000);

// Initialize tooltips and other UI enhancements
document.addEventListener('DOMContentLoaded', function() {
    // Add smooth scrolling to suggestions
    document.querySelectorAll('.suggestion-card').forEach(card => {
        card.addEventListener('click', function() {
            // Smooth scroll to message composer
            document.querySelector('.quick-composer').scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        });
    });
    
    // Add loading states to action buttons
    document.querySelectorAll('.action-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            if (!this.disabled) {
                this.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    this.style.transform = '';
                }, 150);
            }
        });
    });
});

function showComingSoon() {
    alert('This feature is coming soon! Stay tuned for updates.');
}

// Draggable Chatbot Functionality
let isDragging = false;
let currentX;
let currentY;
let initialX;
let initialY;
let xOffset = 0;
let yOffset = 0;

function dragStart(e) {
    if (e.type === "touchstart") {
        initialX = e.touches[0].clientX - xOffset;
        initialY = e.touches[0].clientY - yOffset;
    } else {
        initialX = e.clientX - xOffset;
        initialY = e.clientY - yOffset;
    }

    if (e.target === document.getElementById("chatbotIcon")) {
        isDragging = true;
    }
}

function dragEnd(e) {
    initialX = currentX;
    initialY = currentY;
    isDragging = false;
}

function drag(e) {
    if (isDragging) {
        e.preventDefault();
        
        if (e.type === "touchmove") {
            currentX = e.touches[0].clientX - initialX;
            currentY = e.touches[0].clientY - initialY;
        } else {
            currentX = e.clientX - initialX;
            currentY = e.clientY - initialY;
        }

        xOffset = currentX;
        yOffset = currentY;

        setTranslate(currentX, currentY, document.getElementById("chatbotIcon"));
    }
}

function setTranslate(xPos, yPos, el) {
    el.style.transform = "translate3d(" + xPos + "px, " + yPos + "px, 0)";
}

// Initialize draggable functionality
document.addEventListener("DOMContentLoaded", function() {
    const chatbotIcon = document.getElementById("chatbotIcon");
    if (chatbotIcon) {
        chatbotIcon.addEventListener("touchstart", dragStart, false);
        chatbotIcon.addEventListener("touchend", dragEnd, false);
        chatbotIcon.addEventListener("touchmove", drag, false);
        chatbotIcon.addEventListener("mousedown", dragStart, false);
        chatbotIcon.addEventListener("mouseup", dragEnd, false);
        chatbotIcon.addEventListener("mousemove", drag, false);
    }
});
</script>

{% endblock %}